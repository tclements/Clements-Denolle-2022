using HTTP, DataFrames, CSV, Dates

# script to request groundwater data from USGS wells in California
OUTDIR = "/home/timclements/CALI/DATA/WELLS/USGS/"

# read station info
df = CSV.File("/home/timclements/CALI/USGS-water-stations.csv") |> DataFrame
N = size(df,1)

for ii = 1:N
    println("Requesting station $(df[ii,:SITENO]), $ii of $N")
    # req = "//waterservices.usgs.gov/nwis/gwlevels/?format=rdb&sites=" *
    #        "$(df[ii,:SITENO])&startDT=2007-10-01&" *
    #        "endDT=$(Date(now()))&siteStatus=all"

    req = "https://waterdata.usgs.gov/ca/nwis/dv?cb_72019=on&format=rdb_meas" *
          "&site_no=$(df[ii,:SITENO])&referred_module=gw&period=&" *
          "begin_date=2007-10-01&end_date=$(Date(now() - Day(1)))"
    r = HTTP.request("GET", req; verbose=0);
    rbody = String(r.body)
    outfile = joinpath(OUTDIR,string(df[ii,:SITENO]) * ".csv")

    open(outfile, "w") do f
        write(f, rbody)
    end
    sleep(0.25)
end
